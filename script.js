document.addEventListener("DOMContentLoaded", () => {
    
    loadResponses(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–≤–µ—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

    const ta = document.getElementById('user-input');
    ta.style.resize = 'none';
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ input
    ta.style.overflowY = 'hidden';
    ta.style.height = 'auto';
    ta.style.height = ta.scrollHeight + 'px';
});

let responses = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –æ—Ç–≤–µ—Ç–∞–º–∏

let userName = "–î–∏–º–∞"; // –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è



// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
let storedUserGender = localStorage.getItem("userGender");

// –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
let userGender = storedUserGender ? storedUserGender : "–º—É–∂—á–∏–Ω–∞"; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–æ–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ("–º—É–∂—Å–∫–æ–π" –∏–ª–∏ "–∂–µ–Ω—Å–∫–∏–π")

let userAvatarURL = 'https://sun9-3.userapi.com/impg/Oe6G-yCq8KEP3Z19DcgwonXbwNfhB5DARTyflQ/m89IaVLxWh0.jpg?size=1080x1080&quality=95&sign=e42402995b711c049a2a105b07af8e9e&type=album';


let avatarUrlBot = 'Avrora.jpg';
let BotName = '–ê–≤—Ä–æ—Ä–∞';
let styleMode = "—Ä–æ–¥–Ω–∞—è"; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è (—Ä–æ–¥–Ω–∞—è –∏–ª–∏ –≤–µ–∂–ª–∏–≤–∞—è)













// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ "responses.json"
function loadResponses() {
    fetch("responses.json")  // –ó–∞–≥—Ä—É–∂–∞–µ–º JSON —Ñ–∞–π–ª
        .then(response => response.json()) // –ü–∞—Ä—Å–∏–º JSON-–æ—Ç–≤–µ—Ç
        .then(data => responses = data); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é responses
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function sendMessage() {
    let inputField = document.getElementById("user-input"); // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    let userText = inputField.value.trim(); // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞
    if (userText === "") return; // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    

    formatMessage(userText).then(formattedText => {
        appendMessage(userName, formattedText); // —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
        inputField.value = "";
    
        setTimeout(() => {
            let reply = getResponse(userText.toLowerCase());
            animateBotMessage(reply);
        }, 500);
    });
}    

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.getElementById("user-input").addEventListener("keydown", function(event) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ Ctrl + Enter
    if (event.ctrlKey && (event.key === "Enter" || event.keyCode === 13)) {
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        sendMessage(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    }
});


/**
 * –í—ã–±–∏—Ä–∞–µ—Ç –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ä–∞–∑–¥–µ–ª—è—è –≤–æ–ø—Ä–æ—Å –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —Å —Ü–∏—Ñ—Ä–∞–º–∏.
 * @param {string} userText - –¢–µ–∫—Å—Ç, –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
 * @returns {string} - –û—Ç–≤–µ—Ç –±–æ—Ç–∞.
 */
 // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ò–ò –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 function getResponse(userText) {
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤–æ–π —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const numberRegex = /\d/;
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–≤–æ–π —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–∫—Å—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å –Ω–∞ —á–∞—Å—Ç–∏
    const firstNumberIndex = userText.search(numberRegex);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞
    let questionPrefix = userText; // –ß–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –¥–æ –ø–µ—Ä–≤–æ–π —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç")
    let expressionPart = "";       // –ß–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2 + 3")

    // –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Ü–∏—Ñ—Ä–∞, —Ä–∞–∑–¥–µ–ª—è–µ–º –µ–≥–æ –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏
    if (firstNumberIndex !== -1) {
        questionPrefix = userText.substring(0, firstNumberIndex).trim(); // –î–æ —Ü–∏—Ñ—Ä—ã, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        expressionPart = userText.substring(firstNumberIndex).trim();    // –û—Ç —Ü–∏—Ñ—Ä—ã –∏ –¥–∞–ª—å—à–µ
    }

    // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –≤ –æ–±—ä–µ–∫—Ç–µ responses –∏–∑ —Ñ–∞–π–ª–∞ responses.json
    for (let key in responses) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –¥–æ —Ü–∏—Ñ—Ä—ã –∏–ª–∏ –Ω–∞—á–∞–ª–æ –≤–æ–ø—Ä–æ—Å–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        if (responses[key].questions.some(question => 
            questionPrefix.toLowerCase() === question.toLowerCase() || 
            question.toLowerCase().startsWith(questionPrefix.toLowerCase())
        )) {
            // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è
            let answersObj = responses[key].answers;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Ä–æ–¥–Ω–∞—è")
            if (answersObj && answersObj[styleMode]) {
                let answers = answersObj[styleMode];
                // –í—ã–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî –±–µ—Ä–µ–º –æ–±—â–∏–µ
                let possibleAnswers = answers[userGender] || answers;
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                let randomAnswer = possibleAnswers[Math.floor(Math.random() * possibleAnswers.length)];

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ –æ—Ç–≤–µ—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, $calcbase), –ø–µ—Ä–µ–¥–∞–≤–∞—è —á–∞—Å—Ç—å —Å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º
                return processCommands(randomAnswer, expressionPart || userText);
            }
        }
    }

    // –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —Å–ª—É—á–∞–µ–≤ "–Ω–µ –ø–æ–Ω—è–ª"
    const noResponseAnswers = {
        "–≤–µ–∂–ª–∏–≤–∞—è": [
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω—è–ª–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å.",
            "–ú–æ–≥—É –ª–∏ —è –ø–æ–º–æ—á—å –≤–∞–º —á–µ–º-—Ç–æ –µ—â–µ?",
            "–Ø –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞, —á—Ç–æ –≤—ã –∏–º–µ–µ—Ç–µ –≤ –≤–∏–¥—É. –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?",
            "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ. –î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ.",
            "–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, –Ω–æ —è –Ω–µ –∑–Ω–∞—é, –∫–∞–∫ –Ω–∞ —ç—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å."
        ],
        "—Ä–æ–¥–Ω–∞—è": [
            "–≠–π, —è –Ω–µ –≤—Ä—É–±–∞—é—Å—å, –æ —á–µ–º —Ç—ã.",
            "–ú–æ–∂–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É?",
            "–ß–µ—Ç –Ω–µ –ø–æ–Ω–∏–º–∞—é, –ø–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å.",
            "–•–º, —è –±–µ–∑ –ø–æ–Ω—è—Ç–∏—è. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ.",
            "–û–π, –Ω–µ –∑–Ω–∞—é, –∫–∞–∫ –Ω–∞ —ç—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å."
        ]
    };

    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è
    return noResponseAnswers[styleMode][Math.floor(Math.random() * noResponseAnswers[styleMode].length)];
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ –æ—Ç–≤–µ—Ç–µ –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, $calcbase) –∏ –∑–∞–º–µ–Ω—è–µ—Ç –∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
 * @param {string} answer - –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏.
 * @param {string} userText - –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥.
 * @returns {string} - –û—Ç–≤–µ—Ç —Å –∑–∞–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏.
 */
function processCommands(answer, userText) {
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –≤–∏–¥–∞ $command (–Ω–∞–ø—Ä–∏–º–µ—Ä, $calcbase)
    const commandRegex = /\$(\w+)/g;
    let match;

    // –ü–æ–∫–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
    while ((match = commandRegex.exec(answer)) !== null) {
        const commandName = match[1]; // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "calcbase")
        const commandFunction = commandMap[commandName]; // –ò—â–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ –º–∞–ø–ø–∏–Ω–≥–µ

        // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –Ω–∞–π–¥–µ–Ω–∞
        if (commandFunction) {
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç
            const result = commandFunction(userText, answer);
            // –ó–∞–º–µ–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
            answer = answer.replace(`$${commandName}`, result);
        } else {
            // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞, –∑–∞–º–µ–Ω—è–µ–º –µ—ë –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            answer = answer.replace(`$${commandName}`, "[–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞]");
        }
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –∑–∞–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
    return answer;
}

/**
 * –û–±—ä–µ–∫—Ç, —Å–≤—è–∑—ã–≤–∞—é—â–∏–π –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, $calcbase) —Å –∏—Ö —Ñ—É–Ω–∫—Ü–∏—è–º–∏.
 */
const commandMap = {
    "calcbase": calcbase, // –ö–æ–º–∞–Ω–¥–∞ $calcbase, –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
    "calcage": calcage,    // –ö–æ–º–∞–Ω–¥–∞ $calcage, —Å—á–∏—Ç–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥.—Ä.
    "calcmedical": calcmedical, // –ö–æ–º–∞–Ω–¥–∞ $calcmedical, —Å—á–∏—Ç–∞–µ—Ç –∑–∞–≤—ã—à–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–Ω–∏–∂–µ–Ω–∏–µ –æ—Ç –Ω–æ—Ä–º—ã
    "todaypoem": todaypoem, // –ö–æ–º–∞–Ω–¥–∞ $todaypoem, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –∫–∞—Ç—Ä–µ–Ω–æ–º –∏ –¥–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –Ω –µ–µ
    "detectgender": detectgender
};

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2 + 3").
 * @param {string} userText - –¢–µ–∫—Å—Ç —Å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
 * @param {string} answer - –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ).
 * @returns {string} - –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function calcbase(userText, answer) {
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2 + 3" –∏–ª–∏ "5.5 * 2")
    const calcRegex = /(\d*\.?\d+)\s*([+\-*/])\s*(\d*\.?\d+)/g;
    let expression = userText; // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    let match;

    // –ü–æ–∫–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–∫—Å—Ç–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
    while ((match = calcRegex.exec(expression)) !== null) {
        const num1 = parseFloat(match[1]); // –ü–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä–æ–±–Ω—ã–º)
        const operator = match[2];          // –û–ø–µ—Ä–∞—Ç–æ—Ä (+, -, *, /)
        const num2 = parseFloat(match[3]); // –í—Ç–æ—Ä–æ–µ —á–∏—Å–ª–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä–æ–±–Ω—ã–º)

        let result; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
        switch (operator) {
            case "+":
                result = num1 + num2; // –°–ª–æ–∂–µ–Ω–∏–µ
                break;
            case "-":
                result = num1 - num2; // –í—ã—á–∏—Ç–∞–Ω–∏–µ
                break;
            case "*":
                result = num1 * num2; // –£–º–Ω–æ–∂–µ–Ω–∏–µ
                break;
            case "/":
                if (num2 === 0) return "–î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ"; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
                result = num1 / num2; // –î–µ–ª–µ–Ω–∏–µ
                break;
            default:
                return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä"; // –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        }

        // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2 + 3") –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, "5")
        expression = expression.replace(match[0], result);
        calcRegex.lastIndex = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏—Ç–æ–≥–æ–≤–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á–∏—Å–ª–æ–º
    const finalResult = parseFloat(expression);
    if (!isNaN(finalResult)) {
        return finalResult.toString(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    }

    // –ï—Å–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    return "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è";
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
function calculateExpression(expression) {
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º eval –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (–¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π)
        let result = eval(expression); 

        // –ï—Å–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (!isNaN(result)) {
            return result;
        } else {
            return "–û—à–∏–±–∫–∞ –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö";
        }
    } catch (error) {
        return "–û—à–∏–±–∫–∞ –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö";
    }
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–¥.–º–º.–≥–≥–≥–≥, –¥–¥/–º–º/–≥–≥ –∏ —Ç.–¥.
 * @param {string} userText - –¢–µ–∫—Å—Ç —Å –¥–∞—Ç–æ–π —Ä–æ–∂–¥–µ–Ω–∏—è.
 * @param {string} answer - –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ).
 * @returns {string} - –í–æ–∑—Ä–∞—Å—Ç –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function calcage(userText, answer) {
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö: –¥–¥.–º–º.–≥–≥–≥–≥, –¥–¥/–º–º/–≥–≥, –º–º.–¥–¥.–≥–≥ –∏ —Ç.–¥.
    const dateRegex = /(\d{1,2}[./]\d{1,2}[./](\d{4}|\d{2}))/;
    const match = userText.match(dateRegex);

    // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    if (!match) {
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–¥.–º–º.–≥–≥–≥–≥ –∏–ª–∏Á±ª‰ºº";
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "15.03.1990")
    const dateStr = match[0];
    // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ —Ç–æ—á–∫–∞–º –∏–ª–∏ —Å–ª—ç—à–∞–º
    const separator = dateStr.includes(".") ? "." : "/";
    const parts = dateStr.split(separator);

    let day, month, year;
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç: –¥–¥.–º–º –∏–ª–∏ –º–º.–¥–¥
    if (dateStr.match(/\d{1,2}[./]\d{1,2}[./]\d{2,4}/)) {
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –¥–¥.–º–º.–≥–≥–≥–≥ –∏–ª–∏ –¥–¥/–º–º/–≥–≥
        day = parseInt(parts[0], 10);
        month = parseInt(parts[1], 10) - 1; // –ú–µ—Å—è—Ü—ã –≤ JS –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 0
        year = parseInt(parts[2], 10);
    }

    // –ï—Å–ª–∏ –≥–æ–¥ –¥–≤—É—Ö–∑–Ω–∞—á–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "90"), –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø–æ–ª–Ω—ã–π
    if (year < 100) {
        year += year < 30 ? 2000 : 1900; // –ï—Å–ª–∏ < 30 ‚Äî 20xx, –∏–Ω–∞—á–µ 19xx
    }

    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
    const birthDate = new Date(year, month, day);
    // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ (–∑–∞–¥–∞–µ–º –∫–∞–∫ 22 —Ñ–µ–≤—Ä–∞–ª—è 2025 –≥–æ–¥–∞)
    const today = new Date(2025, 1, 22); // –ú–µ—Å—è—Ü—ã —Å 0, –ø–æ—ç—Ç–æ–º—É 1 = —Ñ–µ–≤—Ä–∞–ª—å

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
    if (isNaN(birthDate.getTime()) || birthDate > today) {
        return "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è";
    }

    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –≥–æ–¥–∞—Ö
    let age = today.getFullYear() - birthDate.getFullYear();
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —ç—Ç–æ–º –≥–æ–¥—É
    const hasBirthdayPassed = today.getMonth() > birthDate.getMonth() ||
                             (today.getMonth() === birthDate.getMonth() && today.getDate() >= birthDate.getDate());

    // –ï—Å–ª–∏ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –µ—â–µ –Ω–µ –ø—Ä–æ—à–µ–ª, —É–º–µ–Ω—å—à–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –Ω–∞ 1
    if (!hasBirthdayPassed) {
        age--;
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    return age.toString();
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –Ω–æ—Ä–º.
 * –ò—â–µ—Ç –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ (–∑–Ω–∞—á–µ–Ω–∏–µ) –∏ –¥–≤–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —á–∏—Å–ª–∞ (–Ω–æ—Ä–º–∞ "–æ—Ç" –∏ "–¥–æ").
 * –í—ã—á–∏—Å–ª—è–µ—Ç, –≤–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∏–ª–∏ –∑–∞–Ω–∏–∂–µ–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ—Ä–º—ã.
 */
function calcmedical(userText, answer) {
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è
    let styleMode = "—Ä–æ–¥–Ω–∞—è"; // –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: "—Ä–æ–¥–Ω–∞—è", "–≤–µ–∂–ª–∏–≤–∞—è"
    
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∏—Å–µ–ª (–≤–∫–ª—é—á–∞—è –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É –∏–ª–∏ –∑–∞–ø—è—Ç—É—é)
    const numberRegex = /\d+(?:[\.,]\d+)?/g;
    let numbers = userText.match(numberRegex);
    
    if (!numbers || numbers.length < 3) {
        return styleMode === "—Ä–æ–¥–Ω–∞—è" 
            ? "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –Ω–æ—Ä–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ —Ç—Ä–∏ —á–∏—Å–ª–∞." 
            : "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –Ω–æ—Ä–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç—Ä–∏ —á–∏—Å–ª–∞.";
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∏—Å–ª–∞ –≤ float, –∑–∞–º–µ–Ω—è—è –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
    let [value, normMin, normMax] = numbers.map(num => parseFloat(num.replace(",", ".")));
    
    if (isNaN(value) || isNaN(normMin) || isNaN(normMax)) {
        return styleMode === "—Ä–æ–¥–Ω–∞—è"
            ? "–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è."
            : "–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.";
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã
    if (value >= normMin && value <= normMax) {
        return styleMode === "—Ä–æ–¥–Ω–∞—è"
            ? "–¢–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –≤ –Ω–æ—Ä–º–µ."
            : "–í–∞—à –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–æ—Ä–º–µ.";
    }
    
    // –í—ã—á–∏—Å–ª—è–µ–º, –≤–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø—Ä–µ–≤—ã—à–µ–Ω –∏–ª–∏ –∑–∞–Ω–∏–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
    let deviation;
    if (value < normMin) {
        deviation = (normMin / value).toFixed(2);
        return styleMode === "—Ä–æ–¥–Ω–∞—è"
            ? `–¢–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∑–∞–Ω–∏–∂–µ–Ω –≤ ${deviation} —Ä–∞–∑.`
            : `–í–∞—à –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∑–∞–Ω–∏–∂–µ–Ω –≤ ${deviation} —Ä–∞–∑.`;
    } else {
        deviation = (value / normMax).toFixed(2);
        return styleMode === "—Ä–æ–¥–Ω–∞—è"
            ? `–¢–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ—Ä–º—É –≤ ${deviation} —Ä–∞–∑.`
            : `–í–∞—à –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ—Ä–º—É –≤ ${deviation} —Ä–∞–∑.`;
    }
}
/**
 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∫–∞—Ç—Ä–µ–Ω–æ–º.
 * @returns {string} - –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∫–∞—Ç—Ä–µ–Ω–æ–º –≤ HTML —Ñ–æ—Ä–º–∞—Ç–µ.
 */
function todaypoem() {
    let today = new Date();
    let day = String(today.getDate()).padStart(2, "0"); 
    let month = String(today.getMonth() + 1).padStart(2, "0"); 
    let year = String(today.getFullYear()).slice(2); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞

    let formattedDate = `${day}.${month}.${year}`;
    let url = `https://blagayavest.info/poems/${formattedDate}.html`;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
    window.open(url, "_blank");

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫—É –≤ HTML —Ñ–æ—Ä–º–∞—Ç–µ
    return `<a href='${url}' target='_blank'>${url}</a> –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∑–Ω–∞—á–∏—Ç –∫–∞—Ç—Ä–µ–Ω –µ—â–µ –Ω–µ –≤—ã—à–µ–ª.`;
}


/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–∏.
 * @param {string} userText - –¢–µ–∫—Å—Ç, –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
 * @param {string} answer - –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ).
 * @returns {string} - –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –ø–æ–ª–µ.
 */
function detectgender(userText, answer) {
    const maleKeywords = ["–º—É–∂—á–∏–Ω–∞", "–º—É–∂.", "–º—É–∂—Å–∫–æ–π", "–º—É–∂–∏–∫", "–º–∞–ª—å—á–∏–∫"];
    const femaleKeywords = ["–∂–µ–Ω—â–∏–Ω–∞", "–∂–µ–Ω.", "–∂–µ–Ω—Å–∫–∏–π", "–¥–µ–≤—É—à–∫–∞", "–¥–µ–≤–æ—á–∫–∞"];

    let detectedGender = null;
    
    if (maleKeywords.some(word => userText.toLowerCase().includes(word))) {
        detectedGender = "–º—É–∂—Å–∫–æ–π";
    } else if (femaleKeywords.some(word => userText.toLowerCase().includes(word))) {
        detectedGender = "–∂–µ–Ω—Å–∫–∏–π";
    }

    if (detectedGender) {
        userGender = detectedGender;
        localStorage.setItem("userGender", detectedGender);
        return `–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª: ${detectedGender}.`;
    }
    
    return "–ü–æ–ª –Ω–µ –∏–∑–º–µ–Ω–µ–Ω.";
}





document.getElementById("user-input").addEventListener("input", function () {
    let textarea = this;
    let text = textarea.value;

    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const imageRegex = /(?<!['"])(https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|webp|svg))(?!['"])/gi;
    
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–∞–π—Ç—ã, –∏—Å–∫–ª—é—á–∞—è YouTube
    const youTubeRegex = /(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)[^\s]+)/;
    const linkRegex = /(?<!['"<])(https?:\/\/(?!www\.youtube\.com|youtu\.be)[^\s]+)(?!['">])/gi;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–ª–∏ YouTube-—Å—Å—ã–ª–∫–∞
    if (/<img\s+src=['"][^'"]+['"]>/i.test(text) || /<a\s+href=['"][^'"]+['"]>/i.test(text) || youTubeRegex.test(text)) {
        return; // –ù–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ —ç—Ç–æ YouTube-—Å—Å—ã–ª–∫–∞
    }

    // –ó–∞–º–µ–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    text = text.replace(imageRegex, "<img src='$1'>");
    
    // –ó–∞–º–µ–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç—ã, –∏—Å–∫–ª—é—á–∞—è YouTube
    text = text.replace(linkRegex, function(match) {
        return /<a\s+href=['"]/.test(text) ? match : `<a href='${match}' target='_blank'>${match}</a>`;
    });
    
    textarea.value = text;
});









// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
async function appendMessage(sender, text) {
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ —á–∞—Ç–∞ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π).
    let chatBox = document.getElementById("chat-box");

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å –ø–æ–º–æ—â—å—é –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.
    let time = getCurrentTime();
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    let messageContainer = document.createElement("div");
    messageContainer.classList.add("message-container"); // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π –∫–ª–∞—Å—Å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

    // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.
    if (sender === BotName) {
        messageContainer.classList.add("bot-message"); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞.
    } else {
        messageContainer.classList.add("user-message"); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    }

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (–∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –±–æ—Ç–∞).
    let avatarElement = document.createElement("img");
    avatarElement.classList.add("avatar"); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞.
    avatarElement.src = sender === BotName ? avatarUrlBot : userAvatarURL; // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –≤—ã–±–∏—Ä–∞–µ–º URL –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞.

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–∞–ª–æ—á–∫–∏, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è).
    let checkmarksElement = document.createElement("div");
    checkmarksElement.classList.add("checkmarks"); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫.
    checkmarksElement.innerHTML = `<span class="checkmark">‚úî</span><span class="checkmark">‚úî</span>`; // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–≤–µ –≥–∞–ª–æ—á–∫–∏.

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
    let timeElement = document.createElement("div");
    timeElement.classList.add("message-time");
    timeElement.textContent = time; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏.

    // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è.
    let messageElement = document.createElement("div");
    messageElement.classList.add("message");

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
    let menuButton = createMenuButton(text, messageContainer);

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.
    let contentSpan = document.createElement("span");
    contentSpan.className = "message-content"; // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º.
    messageElement.innerHTML = `<strong>${sender}:</strong> `;
    messageElement.appendChild(contentSpan); // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–∏–¥–µ–æ YouTube –≤ —Ç–µ–∫—Å—Ç–µ.
    const youTubeRegex = /(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)[^\s]+)/;
    let match = text.match(youTubeRegex); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–∫–∏.

    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –≤–∏–¥–µ–æ YouTube
    if (match) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≤–∏–¥–µ–æ –∏–∑ —Å—Å—ã–ª–∫–∏.
        const videoId = match[0].match(/(?:v=|youtu\.be\/)([\w-]{11})/)[1];
        console.log("YouTube video ID:", videoId); // –õ–æ–≥–∏—Ä—É–µ–º ID –≤–∏–¥–µ–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è iframe (YouTube –≤–∏–¥–µ–æ).
        let iframeContainer = document.createElement("div");
        iframeContainer.style.position = "relative"; // –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ iframe.
        iframeContainer.style.width = "100%";
        iframeContainer.style.height = "250px";
        iframeContainer.style.borderRadius = "15px";
        iframeContainer.style.overflow = "hidden";

        // –°–æ–∑–¥–∞–µ–º —Å–∞–º iframe –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ.
        let iframe = document.createElement("iframe");
        iframe.width = "100%"; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É iframe.
        iframe.height = "100%"; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É iframe.
        iframe.src = `https://www.youtube.com/embed/${videoId}`; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ.
        iframe.frameBorder = "0"; // –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫–∏ —É iframe.
        iframe.allowFullscreen = true; // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º.
        iframe.style.borderRadius = "12px"; // –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è —É–≥–ª–æ–≤.

        iframeContainer.appendChild(iframe); // –î–æ–±–∞–≤–ª—è–µ–º iframe –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        contentSpan.appendChild(iframeContainer); // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ span —Å —Ç–µ–∫—Å—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è.

        console.log("Final contentSpan content:", contentSpan.innerHTML); // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ contentSpan –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ iframe (–∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ).
        iframe.onload = () => {
            console.log("User iframe loaded"); // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ iframe.
            // –°–∫—Ä–æ–ª–ª–∏–º —á–∞—Ç, —á—Ç–æ–±—ã –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞–ª–æ –≤–∏–¥–∏–º—ã–º.
            chatBox.scrollIntoView({ behavior: "smooth", block: "end" });
        };
    } else {
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –≤ contentSpan.
        contentSpan.innerHTML = text;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è.
    messageContainer.appendChild(checkmarksElement); // –î–æ–±–∞–≤–ª—è–µ–º –≥–∞–ª–æ—á–∫–∏.
    messageContainer.appendChild(timeElement); // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è.
    messageContainer.appendChild(messageElement); // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
    messageContainer.appendChild(menuButton); // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é.
    messageContainer.appendChild(avatarElement); // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä.

    // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç.
    chatBox.appendChild(messageContainer);
    // –°–∫—Ä–æ–ª–ª–∏–º —á–∞—Ç, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞–ª–æ –≤–∏–¥–∏–º—ã–º.
    chatBox.scrollIntoView({ behavior: "smooth", block: "end" });
}




// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message) {
    let notification = document.createElement("div");
    notification.classList.add("notification");
    notification.textContent = message;

    let notificationContainer = document.getElementById("notification-container");
    notificationContainer.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = "0";
        setTimeout(() => notification.remove(), 500); // –ë—ã–ª–æ 500, —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 1500
    }, 2000); // –ë—ã–ª–æ 2000, —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 3000
    
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —á—á:–º–º
function getCurrentTime() {
    let date = new Date();
    let hours = date.getHours().toString().padStart(2, '0'); // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∞—Å—ã
    let minutes = date.getMinutes().toString().padStart(2, '0'); // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–∏–Ω—É—Ç—ã
    return `${hours}:${minutes}`; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ —á—á:–º–º
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫–∏, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ)
async function formatMessage(text) {
    console.log("formatMessage input:", text); // –û—Ç–ª–∞–¥–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –õ–æ–≥–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–∏–¥–µ–æ YouTube –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.
    const youTubeRegex = /(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)[^\s]+)/;
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ YouTube.
    let match = text.match(youTubeRegex);

    // –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ YouTube
    if (match) {
        // –°–æ–∑–¥–∞–µ–º HTML –∫–æ–¥ –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è YouTube –≤–∏–¥–µ–æ.
        let videoEmbed = createYouTubeEmbed(match[0]);
        // –ó–∞–º–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤ —Ç–µ–∫—Å—Ç–µ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π HTML —ç–ª–µ–º–µ–Ω—Ç.
        let newText = text.replace(match[0], videoEmbed);
        console.log("formatMessage output (YouTube):", newText); // –û—Ç–ª–∞–¥–∫–∞: –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –≤–∏–¥–µ–æ.
        return newText.trim(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –≤–∏–¥–µ–æ, —É–±–∏—Ä–∞—è –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
    const isImage = await checkIfImage(text);
    // –ï—Å–ª–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (isImage) {
        // –°–æ–∑–¥–∞–µ–º HTML —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ –∏ –≤—ã—Å–æ—Ç–µ.
        let imageHtml = `<img src="${text}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 100%; max-height: 300px; display: block; margin: auto;">`;
        console.log("formatMessage output (Image):", imageHtml); // –û—Ç–ª–∞–¥–∫–∞: –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
        return imageHtml; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML —ç–ª–µ–º–µ–Ω—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª.
    const isAudio = checkIfAudio(text);
    // –ï—Å–ª–∏ —ç—Ç–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª
    if (isAudio) {
        // –°–æ–∑–¥–∞–µ–º HTML —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞.
        let audioHtml = createAudioPlayer(text);
        console.log("formatMessage output (Audio):", audioHtml); // –û—Ç–ª–∞–¥–∫–∞: –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∞—É–¥–∏–æ.
        return audioHtml; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML —ç–ª–µ–º–µ–Ω—Ç –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞.
    }

    // –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–∏–º–≤–æ–ª—ã –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ —Ç–µ–∫—Å—Ç–∞)
    if (text.includes('\n')) {
        // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –∏ –∑–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –Ω–∞ —Ç–µ–≥ <br>, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
        let multiLineText = text.split('\n').join('<br>');
        console.log("formatMessage output (Multiline):", multiLineText); // –û—Ç–ª–∞–¥–∫–∞: –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
        return multiLineText; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —Ç–µ–≥–∞–º–∏ <br>.
    }

    // –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∏–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–µ –ø—Ä–æ—à–ª–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç).
    console.log("formatMessage output (Plain):", text); // –û—Ç–ª–∞–¥–∫–∞: –ª–æ–≥–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç.
    return text; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
}






// –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞ –≤–∏–¥–µ–æ —Å YouTube
function checkIfYouTube(url) {
    const youTubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/;
    return youTubeRegex.test(url);
}

// –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ YouTube-–≤–∏–¥–µ–æ
function createYouTubeEmbed(url) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∏–¥–µ–æ –∏–∑ URL
    const videoId = url.match(/(?:v=|youtu\.be\/)([\w-]{11})/)[1];
    return `
        <div style="
            position: relative;
            width: 100%;
            height: 250px;
            border-radius: 15px;
            overflow: hidden;
        ">
            <iframe 
                width="100%" 
                height="100%" 
                src="https://www.youtube.com/embed/${videoId}" 
                frameborder="0" 
                allowfullscreen
                style="border-radius: 12px;">
            </iframe>
        </div>`;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–º
function checkIfAudio(url) {
    return /\.(mp3|wav|ogg|m4a)$/i.test(url);
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function createAudioPlayer(url) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞
    const audioId = `audio-${Math.random().toString(36).substr(2, 9)}`;
    return `
        <audio id="${audioId}" src="${url}" preload="none"></audio>
        <button onclick="toggleAudio('${audioId}')" 
                style="display: block; margin-top: 5px;">
            ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
        </button>`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –∞—É–¥–∏–æ
function toggleAudio(audioId) {
    const audio = document.getElementById(audioId);
    // –ï—Å–ª–∏ –∞—É–¥–∏–æ –Ω–∞ –ø–∞—É–∑–µ, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –µ–≥–æ, –∏–Ω–∞—á–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if (audio.paused) {
        audio.play();
        event.target.textContent = "‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
    } else {
        audio.pause();
        event.target.textContent = "‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏";
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
function checkIfImage(url) {
    return new Promise(resolve => {
        let img = new Image();
        img.onload = () => resolve(true);  // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true
        img.onerror = () => resolve(false); // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false
        img.src = url;
    });
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—á–∞—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –ò–ò
async function animateBotMessage(text) {
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —á–∞—Ç–∞, –∫—É–¥–∞ –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    let chatBox = document.getElementById("chat-box");

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
    let messageContainer = document.createElement("div");
    messageContainer.classList.add("message-container", "bot-message"); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥–∞–ª–æ—á–µ–∫
    let checkmarksElement = document.createElement("div");
    checkmarksElement.classList.add("checkmarks"); // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–ª–æ—á–µ–∫
    checkmarksElement.innerHTML = `
        <span class="checkmark">‚úî</span>
        <span class="checkmark">‚úî</span>
    `; // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–≤–µ –≥–∞–ª–æ—á–∫–∏ –∫–∞–∫ HTML

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    let timeElement = document.createElement("div");
    timeElement.classList.add("message-time"); // –ö–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
    timeElement.textContent = getCurrentTime(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "14:35")

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    let messageElement = document.createElement("div");
    messageElement.classList.add("message"); // –ö–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–±–æ—Ç–∞) –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
    let senderSpan = document.createElement("strong");
    senderSpan.textContent = `${BotName}: `; // –ò–º—è –±–æ—Ç–∞ –≤—ã–¥–µ–ª–µ–Ω–æ –∂–∏—Ä–Ω—ã–º
    messageElement.appendChild(senderSpan); // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –≤ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    let textSpan = document.createElement("span");
    messageElement.appendChild(textSpan); // –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ—Å–ª–µ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —É–¥–∞–ª–∏—Ç—å)
    let menuButton = createMenuButton(text, messageContainer);

    // –°–æ–∑–¥–∞–µ–º –∞–≤–∞—Ç–∞—Ä –±–æ—Ç–∞
    let botAvatar = document.createElement("img");
    botAvatar.classList.add("avatar"); // –ö–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞
    botAvatar.src = avatarUrlBot; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –∞–≤–∞—Ç–∞—Ä–∞ –±–æ—Ç–∞

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    messageContainer.appendChild(checkmarksElement); // –ì–∞–ª–æ—á–∫–∏ –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏
    messageContainer.appendChild(timeElement); // –ó–∞—Ç–µ–º –≤—Ä–µ–º—è
    messageContainer.appendChild(messageElement); // –ó–∞—Ç–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    messageContainer.appendChild(menuButton); // –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é
    messageContainer.appendChild(botAvatar); // –ê–≤–∞—Ç–∞—Ä –≤ –∫–æ–Ω—Ü–µ

    // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    chatBox.appendChild(messageContainer);

    

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞–≤–µ–¥–µ–Ω–∏—è –º—ã—à–∏ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    messageContainer.addEventListener('mouseenter', function handler() {
        checkmarksElement.classList.add('viewed'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å "viewed", —á—Ç–æ–±—ã –≥–∞–ª–æ—á–∫–∏ —Å—Ç–∞–ª–∏ —Å–∏–Ω–∏–º–∏
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—è, —á—Ç–æ–±—ã —Ü–≤–µ—Ç –Ω–µ –º–µ–Ω—è–ª—Å—è –æ–±—Ä–∞—Ç–Ω–æ
        messageContainer.removeEventListener('mouseenter', handler);
    });

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ç.–¥.)
    let formattedText = await formatMessage(text);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –º–µ–¥–∏–∞ (–≤–∏–¥–µ–æ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∞—É–¥–∏–æ)
    if (formattedText.includes("<iframe") || formattedText.includes("<img") || formattedText.includes("<audio")) {
        textSpan.innerHTML = formattedText; // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞, —Å—Ä–∞–∑—É –≤—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        let iframe = textSpan.querySelector("iframe"); // –ò—â–µ–º iframe (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è YouTube)
        if (iframe) {
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ iframe –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
            iframe.onload = () => {
                setTimeout(() => {
                    messageContainer.scrollIntoView({ behavior: "smooth", block: "end" });
                }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            };
        }
    } else {
        // –ï—Å–ª–∏ –º–µ–¥–∏–∞ –Ω–µ—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞
        animateText(textSpan, text, 0, 50, () => {
            messageContainer.scrollIntoView({ behavior: "smooth", block: "end" }); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        });
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    let img = textSpan.querySelector("img");
    if (img) {
        img.addEventListener("load", () => {
            messageContainer.scrollIntoView({ behavior: "smooth", block: "end" }); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        });
    }

    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
    const observer = new ResizeObserver(() => {
        messageContainer.scrollIntoView({ behavior: "smooth", block: "end" }); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
    });
    observer.observe(messageContainer); // –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é —Å —Ç—Ä–µ–º—è —Ç–æ—á–∫–∞–º–∏
function createMenuButton(text, messageContainer) {
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
    let menuButton = document.createElement("div");
    menuButton.classList.add("menu-button");
    menuButton.textContent = "‚ãÆ";

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    let contextMenu = document.createElement("div");
    contextMenu.classList.add("context-menu");
    contextMenu.style.display = "none"; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    let copyButton = document.createElement("div");
    copyButton.classList.add("context-option", "copy-button"); // –ù–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    let copyIcon = document.createElement("span");
    copyIcon.classList.add("copy-icon"); // –ò–∫–æ–Ω–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    copyIcon.textContent = "üìã"; // –Æ–Ω–∏–∫–æ–¥ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    copyButton.appendChild(copyIcon); // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∫–Ω–æ–ø–∫—É
    copyButton.appendChild(document.createTextNode("–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å")); // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    copyButton.addEventListener("click", (event) => {
        event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–∫ –Ω–µ –∑–∞–∫—Ä—ã–ª –º–µ–Ω—é —Å—Ä–∞–∑—É
        navigator.clipboard.writeText(text); // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        showNotification("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        contextMenu.style.display = "none"; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    });

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    let deleteButton = document.createElement("div");
    deleteButton.classList.add("context-option", "delete-button"); // –ù–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    let deleteIcon = document.createElement("span");
    deleteIcon.classList.add("delete-icon"); // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    deleteIcon.textContent = "üóëÔ∏è"; // –Æ–Ω–∏–∫–æ–¥ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
    deleteButton.appendChild(deleteIcon); // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∫–Ω–æ–ø–∫—É
    deleteButton.appendChild(document.createTextNode("–£–¥–∞–ª–∏—Ç—å")); // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    deleteButton.addEventListener("click", () => {
        messageContainer.remove(); // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        showNotification("–£–¥–∞–ª–µ–Ω–æ"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    contextMenu.appendChild(copyButton);
    contextMenu.appendChild(deleteButton);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
    menuButton.addEventListener("click", (event) => {
        event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        contextMenu.style.display = contextMenu.style.display === "none" ? "block" : "none"; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é
    });

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener("click", () => {
        contextMenu.style.display = "none";
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –≤–Ω—É—Ç—Ä—å –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
    menuButton.appendChild(contextMenu);
    return menuButton; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
}







// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
function animateText(element, text, index = 0, delay = 50, callback = null) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —Ç–µ–≥–∞–º–∏
    const originalText = text;
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏: –∑–∞–º–µ–Ω—è–µ–º <br> –Ω–∞ \n –∏ —É–±–∏—Ä–∞–µ–º —Ç–µ–≥–∏ <b> –∏ <i>
    const animText = text
      .replace(/<br\s*\/?>(?!$)/g, '\n')
      .replace(/<\/?(b|i)>/g, '');
  
    if (index < animText.length) {
      // –ü–æ–æ—á–µ—Ä—ë–¥–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –∏–∑ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
      element.textContent += animText[index];
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
  
      // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª—å—à–∏–º ‚Äì —Å—Ä–∞–∑—É –≤—ã–≤–æ–¥–∏–º –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Ç–µ–∫—Å—Ç
      if (element.textContent.split('\n').length >= 5) {
        setTimeout(() => {
          element.textContent = animText;
          // –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—ã–≤–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç,
          // –∑–∞–º–µ–Ω—è—è \n –Ω–∞ <br>, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑—Ä—ã–≤—ã —Å—Ç—Ä–æ–∫,
          // –∞ HTML-—Ç–µ–≥–∏ (<b>, <i>) —É–∂–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
          element.innerHTML = linkify(originalText.replace(/\n/g, "<br>"));
          document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
          if (callback) callback();

          

        }, 250);
        return;
      }
  
      setTimeout(() => {
        animateText(element, originalText, index + 1, delay, callback);
      }, delay);
    } else {
      element.innerHTML = linkify(originalText.replace(/\n/g, "<br>"));
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
      if (callback) callback();
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
      const chatBox = document.getElementById("chat-box");
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  }
  




// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–º–µ–Ω—ã URL –≤ —Ç–µ–∫—Å—Ç–µ –Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
function linkify(text) {
    let urlPattern = /(\bhttps?:\/\/[^\s]+)/g; // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫
    return text.replace(urlPattern, '$1'); // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏ –±–µ–∑ HTML-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à–∏ "Enter" –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
function handleKeyPress(event) {
    if (event.key === "Enter") {
        sendMessage();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–∏–∫–æ–≤
function toggleEmojiPicker() {
    let emojiPicker = document.getElementById("emoji-picker");
    emojiPicker.style.display = emojiPicker.style.display === "none" ? "block" : "none";
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–∏–∫–∞
function selectEmoji(emoji) {
    let inputField = document.getElementById("user-input");
    inputField.value += emoji; // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–∞–π–ª–∏–∫ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    toggleEmojiPicker(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–∏–∫–æ–≤
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É, —á—Ç–æ–±—ã —Å–≤–µ—Ä–Ω—É—Ç—å –æ–∫–Ω–æ —Å —ç–º–æ–¥–∑–∏, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω–µ –µ–≥–æ
document.addEventListener("click", (event) => {
    let emojiPicker = document.getElementById("emoji-picker");
    let emojiButton = document.getElementById("emoji-button");
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –≤–Ω–µ –æ–∫–Ω–∞ —Å —ç–º–æ–¥–∑–∏ –∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
    if (!emojiPicker.contains(event.target) && event.target !== emojiButton) {
        emojiPicker.style.display = "none"; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —ç–º–æ–¥–∑–∏
    }
});


